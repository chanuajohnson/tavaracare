
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Use environment variables instead of hardcoded values
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
const CURRENT_ENV = import.meta.env.VITE_ENV || 'development';

// Improved error handling and logging for initialization
if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
  console.error(`
    ⚠️ Missing Supabase credentials ⚠️
    
    Required environment variables not found:
    ${!SUPABASE_URL ? '- VITE_SUPABASE_URL' : ''}
    ${!SUPABASE_PUBLISHABLE_KEY ? '- VITE_SUPABASE_ANON_KEY' : ''}
    
    For local development:
    1. Copy .env.development.example to .env.development
    2. Copy .env.production.example to .env.production.local
    3. Fill in your Supabase values
    
    For deployment:
    Ensure GitHub Secrets are correctly configured.
  `);
}

// Better logging for environment detection
console.log(`Supabase Client Initialization (${CURRENT_ENV})`);
console.log(`Supabase URL: ${SUPABASE_URL?.substring(0, 16) || 'UNDEFINED'}...`);
console.log(`Environment: ${CURRENT_ENV}`);

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Fallback values for development only - NOT FOR PRODUCTION
// This helps developers get started but won't work with authentication
const developmentFallbackUrl = 'https://jvvdcnfmttpclxgaqeay.supabase.co';
const developmentFallbackKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmRjbmZtdHRwY2x4Z2FxZWF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwODI2NzIsImV4cCI6MjA1ODY1ODY3Mn0.UHuUbuDtjAPRba_QlDN5QaxVbAmzTN3jXOqXHNJRTpY';

// Use the provided values or fallback to development values in development mode only
const finalSupabaseUrl = SUPABASE_URL || (CURRENT_ENV === 'development' ? developmentFallbackUrl : '');
const finalSupabaseKey = SUPABASE_PUBLISHABLE_KEY || (CURRENT_ENV === 'development' ? developmentFallbackKey : '');

// If we still don't have values, log a more specific error
if (!finalSupabaseUrl || !finalSupabaseKey) {
  console.error(`
    ⚠️ Supabase initialization failed ⚠️
    
    Could not determine Supabase credentials even after applying fallbacks.
    This is likely a configuration issue that needs to be resolved.
    
    Current values:
    - URL: ${finalSupabaseUrl ? '[MASKED]' : 'UNDEFINED'}
    - Key: ${finalSupabaseKey ? '[PRESENT]' : 'UNDEFINED'}
    - Environment: ${CURRENT_ENV}
  `);
}

export const supabase = createClient<Database>(
  finalSupabaseUrl,
  finalSupabaseKey, 
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storageKey: `supabase.auth.token.${CURRENT_ENV}`,
    },
    global: {
      headers: {
        'x-client-env': CURRENT_ENV,
        'x-app-version': '1.0', // Helps with debugging client/server mismatches
      },
    },
    // Added debug mode for development
    db: {
      schema: 'public',
    },
  }
);

// Add a helper function to identify the current environment
export const getCurrentEnvironment = (): 'development' | 'preview' | 'production' => {
  return CURRENT_ENV as 'development' | 'preview' | 'production' || 'development';
};

// Log the active environment and URL for debugging
console.log(`Active environment: ${getCurrentEnvironment()}`);
console.log(`Using Supabase project: ${finalSupabaseUrl || 'UNDEFINED'}`);

// Helper to detect development vs production environment
export const isDevelopment = (): boolean => {
  return getCurrentEnvironment() === 'development';
};

export const isProduction = (): boolean => {
  return getCurrentEnvironment() === 'production';
};

// Function to help debug environment issues
export const getEnvironmentInfo = () => {
  return {
    environment: getCurrentEnvironment(),
    supabaseUrl: finalSupabaseUrl ? `${finalSupabaseUrl.substring(0, 16)}...` : 'NOT SET',
    isDev: isDevelopment(),
    isProd: isProduction(),
    projectId: finalSupabaseUrl?.split('.')[0]?.split('//')[1] || 'unknown',
    clientHeaders: {
      'x-client-env': CURRENT_ENV,
      'x-app-version': '1.0',
    },
    usingFallbacks: !SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY,
  };
};

// Helper function to verify schema compatibility
export const verifySchemaCompatibility = async (): Promise<{
  compatible: boolean;
  missingColumns: string[];
  tables: string[];
}> => {
  try {
    // List of columns to check for proper functionality
    const requiredColumns = [
      { table: 'profiles', column: 'onboarding_progress' },
      { table: 'profiles', column: 'role' },
      { table: 'profiles', column: 'professional_type' }
    ];
    
    const missingColumns: string[] = [];
    const tables: string[] = [];
    
    // Check if tables and columns exist
    for (const { table, column } of requiredColumns) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select(column)
          .limit(1);
        
        if (error) {
          if (error.message.includes('column') && error.message.includes('does not exist')) {
            missingColumns.push(`${table}.${column}`);
          }
        } else {
          if (!tables.includes(table)) {
            tables.push(table);
          }
        }
      } catch (e) {
        console.error(`Error checking ${table}.${column}:`, e);
        missingColumns.push(`${table}.${column}`);
      }
    }
    
    return {
      compatible: missingColumns.length === 0,
      missingColumns,
      tables
    };
  } catch (err) {
    console.error('Error verifying schema compatibility:', err);
    return {
      compatible: false,
      missingColumns: ['Error checking compatibility'],
      tables: []
    };
  }
};

// Helper to reset the auth state in case of issues
export const resetAuthState = async (): Promise<boolean> => {
  try {
    await supabase.auth.signOut({ scope: 'global' });
    return true;
  } catch (err) {
    console.error('Error resetting auth state:', err);
    return false;
  }
};

// Create a debugging component to help identify Supabase connection issues
export const debugSupabaseConnection = async (): Promise<{
  connected: boolean;
  message: string;
  details: any;
}> => {
  try {
    const { data, error } = await supabase.from('profiles').select('count').limit(1);
    
    if (error) {
      return {
        connected: false,
        message: `Connection error: ${error.message}`,
        details: {
          error,
          environmentInfo: getEnvironmentInfo(),
        }
      };
    }
    
    return {
      connected: true,
      message: "Successfully connected to Supabase",
      details: {
        data,
        environmentInfo: getEnvironmentInfo(),
      }
    };
  } catch (err) {
    return {
      connected: false,
      message: `Unexpected error: ${err instanceof Error ? err.message : String(err)}`,
      details: {
        error: err,
        environmentInfo: getEnvironmentInfo(),
      }
    };
  }
};
